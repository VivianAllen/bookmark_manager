require 'pg'

task :test_database_setup do
  p 'RAKE: setting up test database'
  con = PG.connect :dbname => 'bookmark_manager_test'
  con.exec('TRUNCATE TABLE "links";')
  con.exec("INSERT INTO links(id, url, title) VALUES(1, 'http://www.makersacademy.com', 'Makers Academy');")
  con.exec("INSERT INTO links(id, url, title) VALUES(2, 'http://www.google.com', 'Google');")
  con.exec("INSERT INTO links(id, url, title) VALUES(3, 'http://www.facebook.com', 'Facebook');")
end

task :create_db do
  dbname = 'bookmark_manager'
  if con.exec("SELECT datname FROM pg_catalog.pg_database WHERE "\
    "lower(datname) = lower('#{dbname}');").count.zero?
    p 'RAKE: setting up #{dbname} database'
    con.exec("CREATE DATABASE #{dbname};")
  else
    p "#{dbname} already exists, ignoring"
  end
end

task :create_test_db do
  dbname = 'bookmark_manager_test'
  if con.exec("SELECT datname FROM pg_catalog.pg_database WHERE "\
    "lower(datname) = lower('#{dbname}');").count.zero?
    p 'RAKE: setting up #{dbname} database'
    con.exec("CREATE DATABASE #{dbname};")
  else
    p "#{dbname} already exists, ignoring"
  end
end

task :create_all_db do
  RAKE::create_db
  RAKE::create_test_db
end

task :create_table do
  p 'RAKE: setting up database links table'
  dbname = 'bookmark_manager'
  con = PG.connect :dbname => dbname
  con.exec('CREATE TABLE IF NOT EXISTS links(id SERIAL PRIMARY KEY, url VARCHAR(60), title VARCHAR(60));')
end

task :create_test_table do
  p 'RAKE: setting up database test table'
  dbname = 'bookmark_manager_test'
  con = PG.connect :dbname => dbname
  con.exec('CREATE TABLE IF NOT EXISTS links(id SERIAL PRIMARY KEY, url VARCHAR(60), title VARCHAR(60));')
end

task :create_all_tables do
  Rake::Task[:create_table].execute
  Rake::Task[:create_test_table].execute
end

task :reset_table do
  p 'RAKE: clearing bookmarks links table'
  con = PG.connect :dbname => 'bookmark_manager'
  con.exec('TRUNCATE TABLE "links";')
end

task :reset_test_table do
  p 'RAKE: clearing bookmark test links table'
  con = PG.connect :dbname => 'bookmark_manager_test'
  con.exec('TRUNCATE TABLE "links";')
end

task :reset_all_tables do
  Rake::Task[:reset_table].execute
  Rake::Task[:reset_test_table].execute
end

task :drop_table do
  p 'deleting bookmarks links table'
  con = PG.connect :dbname => 'bookmark_manager'
  con.exec('DROP TABLE IF EXISTS "links";')
end

task :drop_test_table do
  p 'deleting bookmarks test link table'
  con = PG.connect :dbname => 'bookmark_manager_test'
  con.exec('DROP TABLE IF EXISTS "links";')
end

task :drop_all_tables do
  Rake::Task[:drop_table].execute
  Rake::Task[:drop_test_table].execute
end
